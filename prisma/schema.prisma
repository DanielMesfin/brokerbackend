generator client {
  provider = "prisma-client-js"
}

model KnowledgeDoc {
  id        String   @id @default(uuid())
  title     String
  source    String?
  text      String
  embedding String? // base64 or JSON string for simple storage
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([title])
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String             @id @default(uuid())
  email               String             @unique
  passwordHash        String
  firstName           String?
  secondName          String?
  phone               String?
  role                String             @default("USER")
  isActive            Boolean            @default(true)
  lastLogin           DateTime?
  refreshToken        String?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  comments            Comment[]
  likes               Like[]
  posts               Post[]
  listings            Listing[]
  profile             UserProfile?
  businesses          BusinessMember[]
  sentConnections     Connection[]       @relation("SentConnections")
  receivedConnections Connection[]       @relation("ReceivedConnections")
  buyerConversations  Conversation[]     @relation("BuyerConversations")
  sellerConversations Conversation[]     @relation("SellerConversations")
  buyerDraftOrders    DraftOrder[]       @relation("BuyerDraftOrders")
  sellerDraftOrders   DraftOrder[]       @relation("SellerDraftOrders")
  verificationCodes   VerificationCode[]
  verifiedVerifications BusinessVerification[] @relation("VerifiedByUser")
  acceptedCompliances  BusinessCompliance[]    @relation("AcceptedByUser")
}

model UserProfile {
  id            String      @id @default(uuid())
  userId        String      @unique
  bio           String?
  avatar        String?
  website       String?
  location      String?
  dateOfBirth   DateTime?
  isVerified    Boolean     @default(false)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  user          User        @relation(fields: [userId], references: [id])
  socialLinks   SocialLink? @relation(fields: [socialLinksId], references: [id])
  socialLinksId String?     @unique
}

model VerificationCode {
  id        String   @id @default(uuid())
  userId    String
  code      String
  type      String // 'EMAIL' or 'PHONE'
  isUsed    Boolean  @default(false)
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, type], name: "userId_type")
}

model SocialLink {
  id             String       @id @default(uuid())
  facebookUrl    String?
  instagramUrl   String?
  tiktokUrl      String?
  youtubeUrl     String?
  linkedinUrl    String?
  twitterUrl     String?
  telegramUrl    String?
  whatsappNumber String?
  websiteUrl     String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  userProfile    UserProfile?
}

model Post {
  id          String    @id @default(uuid())
  content     String
  media       String    @default("[]")
  authorId    String
  isPublished Boolean   @default(true)
  isDeleted   Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  comments    Comment[]
  likes       Like[]
  author      User      @relation(fields: [authorId], references: [id])

  @@index([authorId])
}

model Business {
  id           String               @id @default(uuid())
  name         String
  description  String?
  logo         String?
  website      String?
  industry     String?
  size         String? // e.g., '1-10', '11-50', '51-200', '201-500', '500+'
  isVerified   Boolean              @default(false)
  taxId        String?
  registrationNumber String?
  country      String?
  address      String?
  city         String?
  state        String?
  postalCode   String?
  phone        String?
  email        String?
  status       String              @default("PENDING") // PENDING, ACTIVE, SUSPENDED
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  members      BusinessMember[]
  listings     Listing[]
  documents    BusinessDocument[]
  verifications BusinessVerification[]
  compliances  BusinessCompliance[]

  @@index([name])
  @@index([industry])
  @@index([status])
  @@index([taxId])
  @@index([registrationNumber])
}

model BusinessVerification {
  id           String    @id @default(uuid())
  businessId   String
  type         String    // TAX_ID, REGISTRATION, BANK_ACCOUNT, etc.
  status       String    @default("PENDING") // PENDING, APPROVED, REJECTED
  documentUrl  String?
  verifiedAt   DateTime?
  verifiedById String?
  notes        String?
  metadata     String?   // JSON string for additional data
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  business     Business  @relation(fields: [businessId], references: [id])
  verifiedBy   User?     @relation("VerifiedByUser", fields: [verifiedById], references: [id])

  @@index([businessId])
  @@index([status])
  @@index([type])
}

model BusinessCompliance {
  id               String    @id @default(uuid())
  businessId       String
  policyVersion    String
  acceptedAt       DateTime  @default(now())
  acceptedByUserId String
  ipAddress        String?
  userAgent        String?
  business         Business  @relation(fields: [businessId], references: [id])
  acceptedBy       User      @relation("AcceptedByUser", fields: [acceptedByUserId], references: [id])

  @@index([businessId])
  @@index([acceptedByUserId])
}

model BusinessDocument {
  id          String    @id @default(uuid())
  businessId  String
  type        String    // TAX_ID, REGISTRATION, LICENSE, OTHER
  name        String
  description String?
  fileUrl     String
  fileType    String?
  fileSize    Int?      // Size in bytes
  status      String    @default("PENDING") // PENDING, APPROVED, REJECTED
  metadata    String?   // JSON string for additional data
  uploadedAt  DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  business    Business  @relation(fields: [businessId], references: [id])

  @@index([businessId])
  @@index([type])
  @@index([status])
}

model BusinessMember {
  id         String   @id @default(uuid())
  userId     String
  businessId String
  role       String   @default("MEMBER")
  joinedAt   DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id])
  business   Business @relation(fields: [businessId], references: [id])

  @@unique([userId, businessId])
  @@index([businessId])
}

model Connection {
  id          String    @id @default(uuid())
  senderId    String
  receiverId  String
  status      String    @default("PENDING")
  message     String?
  connectedAt DateTime?
  sender      User      @relation("SentConnections", fields: [senderId], references: [id])
  receiver    User      @relation("ReceivedConnections", fields: [receiverId], references: [id])

  @@unique([senderId, receiverId])
  @@index([receiverId])
  @@index([status])
}

model Listing {
  id             String         @id @default(uuid())
  title          String
  description    String
  type           String // 'C2C', 'B2B', 'B2C', 'B2G'
  price          Float
  category       String
  tags           String // Stored as JSON string
  commissionRate Float?
  isNegotiable   Boolean        @default(false)
  imageUrls      String? // Stored as JSON string
  userId         String? // Nullable for business listings
  businessId     String? // If listing is posted by a business
  isActive       Boolean        @default(true)
  views          Int            @default(0)
  status         String         @default("PENDING") // 'DRAFT', 'PENDING', 'APPROVED', 'REJECTED', 'SOLD', 'EXPIRED'
  quantity       Int            @default(1)
  minOrder       Int            @default(1)
  maxOrder       Int?
  leadTime       String? // e.g., '1-2 weeks', '3-5 days'
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  user           User?          @relation(fields: [userId], references: [id])
  business       Business?      @relation(fields: [businessId], references: [id])
  conversations  Conversation[]
  DraftOrder     DraftOrder[]

  @@index([userId])
  @@index([businessId])
  @@index([status])
  @@index([type])
  @@index([category])
}

model Comment {
  id        String   @id @default(uuid())
  content   String
  postId    String
  authorId  String
  parentId  String?
  isDeleted Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  author    User     @relation(fields: [authorId], references: [id])
  post      Post     @relation(fields: [postId], references: [id])

  @@index([postId])
  @@index([authorId])
}

model Like {
  id        String   @id @default(uuid())
  postId    String
  userId    String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
  post      Post     @relation(fields: [postId], references: [id])

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
}

model Follow {
  id          String   @id @default(uuid())
  followerId  String
  followingId String
  createdAt   DateTime @default(now())

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

model Customer {
  id              String   @id @default(uuid())
  companyName     String
  contactPerson   String
  email           String   @unique
  phone           String?
  billingAddress  String?
  shippingAddress String?
  taxId           String?
  paymentTerms    Int?     @default(30)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([email])
  @@index([companyName])
}

model Conversation {
  id           String       @id @default(uuid())
  listingId    String?
  buyerUserId  String?
  sellerUserId String?
  status       String       @default("DRAFT") // DRAFT, PUBLISHED, SOLD, ARCHIVED
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  listing      Listing?     @relation(fields: [listingId], references: [id])
  buyer        User?        @relation("BuyerConversations", fields: [buyerUserId], references: [id])
  seller       User?        @relation("SellerConversations", fields: [sellerUserId], references: [id])
  messages     Message[]
  agentRuns    AgentRun[]
  draftOrders  DraftOrder[]

  @@index([listingId])
  @@index([buyerUserId])
  @@index([sellerUserId])
}

/// A single message in a conversation, from USER, AGENT, or ADMIN
model Message {
  id             String   @id @default(uuid())
  conversationId String
  senderType     String // USER | AGENT | ADMIN
  text           String
  metadata       String? // JSON string for structured data
  createdAt      DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id])

  @@index([conversationId])
}

/// Records an AI agent run/decision for traceability
model AgentRun {
  id             String   @id @default(uuid())
  conversationId String
  input          String // JSON input to the agent
  output         String // JSON output from the agent
  decision       String // ASK | COLLECT | ESCALATE | PLACE_ORDER | CLOSE
  createdAt      DateTime @default(now())

  conversation Conversation @relation(fields: [conversationId], references: [id])

  @@index([conversationId])
}

/// A draft order created by the agent pending confirmation
model DraftOrder {
  id             String   @id @default(uuid())
  conversationId String
  listingId      String
  buyerUserId    String
  sellerUserId   String
  quantity       Int      @default(1)
  priceAgreed    Float?
  status         String   @default("DRAFT") // DRAFT | PENDING | CONFIRMED | CANCELLED
  shippingInfo   String? // JSON (address, method)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  conversation Conversation @relation(fields: [conversationId], references: [id])
  listing      Listing      @relation(fields: [listingId], references: [id])
  buyer        User         @relation("BuyerDraftOrders", fields: [buyerUserId], references: [id])
  seller       User         @relation("SellerDraftOrders", fields: [sellerUserId], references: [id])

  @@index([conversationId])
  @@index([listingId])
  @@index([buyerUserId])
  @@index([sellerUserId])
}
